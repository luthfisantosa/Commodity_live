<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Dashboard Harga Emas (API Ninjas)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    background-color: #f5f5f7;
    color: #1c1c1e;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    margin-top: 20px;
    color: #111;
  }
  .card {
    background-color: #ffffffcc;
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 25px;
    margin-top: 20px;
    width: 90%;
    max-width: 700px;
  }
  .controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
  }
  button {
    background-color: #007aff;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 8px 14px;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover {
    background-color: #005bb5;
  }
  .info {
    text-align: center;
    font-size: 16px;
    margin-top: 10px;
  }
  .alarm {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  input[type=number] {
    padding: 6px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  .notice {
    background: #fff3cd;
    color: #856404;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    display: none;
  }
</style>
</head>
<body>
  <h1>üìà Live Harga Emas - API Ninjas</h1>
  <div class="card">
    <div class="info">
      <div>Harga Saat Ini: <b id="price">Loading...</b></div>
      <div>Waktu: <span id="time">-</span></div>
    </div>

    <canvas id="chart" height="120"></canvas>

    <div class="controls">
      <button onclick="setRefresh(60000)">‚è± 60 Detik</button>
      <button onclick="setRefresh(1000)">‚ö° 1 Detik (Premium)</button>
      <button onclick="manualRefresh()">üîÑ Refresh Sekarang</button>
    </div>

    <div id="premiumNotice" class="notice">
      Mode 1 detik hanya untuk pelanggan premium.<br>
      Harga berlangganan: <b>Rp 700.000</b><br>
      <button onclick="closeNotice()">Tutup</button>
    </div>

    <div class="alarm">
      <label>Set Alarm Harga:</label>
      <input type="number" id="alarmValue" placeholder="Masukkan harga target (Rp)">
      <select id="alarmCondition">
        <option value="above">‚â• Target</option>
        <option value="below">‚â§ Target</option>
      </select>
      <button onclick="setAlarm()">üîî Set Alarm</button>
      <button onclick="testAlarm()">üîä Tes Suara</button>
      <div id="alarmStatus"></div>
    </div>
  </div>

  <audio id="alarmSound">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>

<script>
let chart;
let priceData = [];
let timeData = [];
let refreshInterval = 60000;
let intervalId = null;
let alarmValue = null;
let alarmCondition = "above";
const apiKey = "1uJVdDfwabtrO+OjWyRHhA==hUYLyqpcRg8JyLHC";

async function fetchPrice() {
  try {
    const response = await fetch("https://api.api-ninjas.com/v1/commodityprice?name=gold", {
      headers: { "X-Api-Key": apiKey }
    });
    const data = await response.json();
    const priceUSD = data[0]?.price || 0;
    const priceIDR = priceUSD * 16000;
    const now = new Date().toLocaleTimeString();
    
    document.getElementById("price").innerText = "Rp " + priceIDR.toLocaleString("id-ID");
    document.getElementById("time").innerText = now;

    priceData.push(priceIDR);
    timeData.push(now);
    if (priceData.length > 20) {
      priceData.shift();
      timeData.shift();
    }
    updateChart();

    // Alarm check
    if (alarmValue) {
      if (
        (alarmCondition === "above" && priceIDR >= alarmValue) ||
        (alarmCondition === "below" && priceIDR <= alarmValue)
      ) {
        document.getElementById("alarmSound").play();
        alert(`üéØ Harga telah mencapai target: Rp ${priceIDR.toLocaleString("id-ID")}`);
        alarmValue = null; // reset alarm
      }
    }
  } catch (err) {
    console.error("Error fetching price:", err);
  }
}

function updateChart() {
  if (!chart) {
    const ctx = document.getElementById("chart").getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: timeData,
        datasets: [{
          label: "Harga Emas (Rp)",
          data: priceData,
          borderColor: "#007aff",
          borderWidth: 2,
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { display: false } }
      }
    });
  } else {
    chart.data.labels = timeData;
    chart.data.datasets[0].data = priceData;
    chart.update();
  }
}

function setRefresh(ms) {
  clearInterval(intervalId);
  if (ms === 1000) {
    document.getElementById("premiumNotice").style.display = "block";
    setTimeout(() => closeNotice(), 5000);
    ms = 60000;
  }
  refreshInterval = ms;
  intervalId = setInterval(fetchPrice, refreshInterval);
}

function closeNotice() {
  document.getElementById("premiumNotice").style.display = "none";
}

function manualRefresh() {
  fetchPrice();
}

function setAlarm() {
  alarmValue = parseFloat(document.getElementById("alarmValue").value);
  alarmCondition = document.getElementById("alarmCondition").value;
  if (!alarmValue) {
    alert("Masukkan harga target terlebih dahulu!");
    return;
  }
  document.getElementById("alarmStatus").innerText = `üîî Alarm aktif untuk ${alarmCondition === "above" ? "‚â•" : "‚â§"} Rp ${alarmValue.toLocaleString("id-ID")}`;
}

function testAlarm() {
  document.getElementById("alarmSound").play();
}

fetchPrice();
intervalId = setInterval(fetchPrice, refreshInterval);
</script>
</body>
</html>
