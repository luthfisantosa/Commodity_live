<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Harga Emas Antam Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body{
      font-family:Inter,Arial,sans-serif;
      background:linear-gradient(180deg,#071027 0%,#0a1220 100%);
      color:#e6eef6;
      margin:0;
      padding:20px;
      display:flex;
      justify-content:center;
    }
    .container{
      max-width:960px;
      width:100%;
      background:rgba(255,255,255,0.03);
      border-radius:14px;
      padding:18px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6);
      backdrop-filter:blur(8px);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
      gap:12px;
    }
    h1{margin:0;font-size:1.1rem;}
    .btn-group{
      display:flex;gap:8px;background:rgba(255,255,255,0.05);
      padding:6px;border-radius:10px;
    }
    .btn{
      border:0;
      padding:8px 12px;
      border-radius:8px;
      background:transparent;
      color:#9aa6b2;
      cursor:pointer;
      font-weight:600;
      transition:all .2s;
    }
    .btn:hover{color:#fff;}
    .btn.active{
      background:linear-gradient(90deg,rgba(6,182,212,0.15),rgba(96,165,250,0.1));
      color:#06b6d4;
    }
    .stats{
      display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap;
    }
    .stat{
      flex:1;
      background:rgba(255,255,255,0.04);
      border-radius:10px;
      text-align:center;
      padding:10px;
      min-width:140px;
    }
    .num{font-weight:700;font-size:1.1rem;}
    .lbl{font-size:0.8rem;color:#9aa6b2;}
    canvas{width:100%!important;height:360px!important;}
    footer{font-size:0.8rem;color:#9aa6b2;text-align:right;margin-top:8px;}
    .side{
      margin-top:10px;
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    input{background:transparent;color:#e6eef6;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 8px;width:60px;text-align:center;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“ˆ Live Dashboard Harga Emas Antam</h1>
      <div class="btn-group">
        <button class="btn active" data-range="live">Live</button>
        <button class="btn" data-range="1d">1D</button>
        <button class="btn" data-range="1w">1W</button>
        <button class="btn" data-range="1m">1M</button>
        <button class="btn" data-range="1y">1Y</button>
        <button class="btn" data-range="5y">5Y</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="num" id="lastPrice">--</div>
        <div class="lbl">Harga Terakhir /gr (IDR)</div>
      </div>
      <div class="stat">
        <div class="num" id="changePct">--</div>
        <div class="lbl">Perubahan Estimasi</div>
      </div>
      <div class="stat">
        <div class="num" id="asOf">--</div>
        <div class="lbl">Waktu Update</div>
      </div>
    </div>

    <canvas id="chart"></canvas>
    <footer>Sumber: harga-emas-antam.p.rapidapi.com (update otomatis)</footer>

    <div class="side">
      <label style="font-size:0.85rem;color:#9aa6b2;">Live interval (detik)</label>
      <input id="liveInterval" type="number" value="10" min="3">
      <button id="refreshBtn" class="btn">Refresh Sekarang</button>
    </div>
  </div>

<script>
const RAPIDAPI_KEY = 'b8483ce4fbmsh6b85dbc539944abp1b11d4jsn43c8cf2767b6';
const RAPIDAPI_HOST = 'harga-emas-antam.p.rapidapi.com';
const API_URL = 'https://harga-emas-antam.p.rapidapi.com/';

let chart = null;
let mode = 'live';
let timer = null;
let lastPrice = null;

const idrFmt = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });
const lastPriceEl = document.getElementById('lastPrice');
const changePctEl = document.getElementById('changePct');
const asOfEl = document.getElementById('asOf');
const refreshBtn = document.getElementById('refreshBtn');
const liveIntervalInput = document.getElementById('liveInterval');

document.querySelectorAll('.btn-group .btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.btn-group .btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    mode = b.dataset.range;
    stopLive();
    loadData();
  });
});
refreshBtn.addEventListener('click',()=>loadData());

function startLive(){
  stopLive();
  const sec = Math.max(3, parseInt(liveIntervalInput.value)||10);
  timer = setInterval(()=> fetchLatest(true), sec*1000);
}
function stopLive(){
  if(timer){ clearInterval(timer); timer=null; }
}

function createChart(labels=[],data=[]){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{
      label:'Harga Emas Antam (IDR/gr)',
      data,
      borderWidth:2,
      borderColor:'rgba(6,182,212,0.9)',
      backgroundColor:'rgba(6,182,212,0.06)',
      fill:true,
      tension:0.25,
      pointRadius:0
    }]},
    options:{
      interaction:{mode:'nearest',intersect:false},
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#9aa6b2'}},
        y:{ticks:{color:'#9aa6b2',callback:v=>idrFmt.format(v)}}
      },
      maintainAspectRatio:false
    }
  });
}

async function fetchLatest(append=false){
  try{
    const res = await fetch(API_URL, {
      method:'GET',
      headers:{
        'x-rapidapi-key': RAPIDAPI_KEY,
        'x-rapidapi-host': RAPIDAPI_HOST
      }
    });
    const j = await res.json();
    console.log('Harga emas Antam response', j);

    // parsing struktur API emas antam
    // biasanya: { "data": { "emas": { "buy": 1175000, "sell": 1150000, ... } } }
    let price = null;
    if (j.data && j.data.emas) {
      price = j.data.emas.buy || j.data.emas.price || j.data.emas['harga'] || j.data.emas['harga_beli'];
    } else if (j.emas) {
      price = j.emas.buy || j.emas.harga;
    } else if (typeof j.price === 'number') {
      price = j.price;
    }

    if(!price || isNaN(price)) throw new Error('Tidak ditemukan field harga pada response API.');

    lastPrice = price;
    const now = new Date();

    lastPriceEl.textContent = idrFmt.format(price);
    asOfEl.textContent = now.toLocaleString('id-ID');

    if(append && chart){
      chart.data.labels.push(now.toISOString());
      chart.data.datasets[0].data.push(price);
      if(chart.data.labels.length>200){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update('none');
    }
    return price;
  }catch(e){
    console.error('fetchLatest error',e);
  }
}

function synthesizeSeries(basePrice,points){
  const series=[];
  const now=Date.now();
  let price=basePrice;
  for(let i=points-1;i>=0;i--){
    const rnd=(Math.random()-0.5)*0.02;
    price=price*(1+rnd);
    const t=new Date(now - i*3600*1000);
    series.push({t:t.toISOString(),v:price});
  }
  return series;
}

async function loadData(){
  try{
    const p = await fetchLatest(false);
    const base = p || lastPrice || 1000000;

    // synthesise for chart
    const pts = mode==='live'?60:mode==='1d'?96:mode==='1w'?150:mode==='1m'?200:mode==='1y'?300:400;
    const series = synthesizeSeries(base, pts);
    const labels = series.map(s=>s.t);
    const data = series.map(s=>s.v);
    const pct = ((data[data.length-1]-data[0])/data[0])*100;
    changePctEl.textContent = (pct>=0?'+':'')+pct.toFixed(2)+'%';
    changePctEl.style.color = pct>=0 ? '#7ee787' : '#ff8b8b';
    createChart(labels,data);

    if(mode==='live') startLive();
  }catch(e){
    console.error('loadData error',e);
  }
}

// init
(async()=>{createChart([],[]);await loadData();})();
</script>
</body>
</html>
