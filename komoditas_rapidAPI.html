<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ“ˆ Live Dashboard Harga Emas (API Ninjas)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(160deg, #f3f4f6 0%, #e2e3e7 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 960px;
      background: rgba(255,255,255,0.8);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.5);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 10px;
    }
    h1 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: #222;
    }
    .btn-group {
      display: flex;
      gap: 6px;
      background: #f1f1f1;
      padding: 5px;
      border-radius: 12px;
    }
    .btn {
      border: none;
      padding: 7px 12px;
      border-radius: 8px;
      background: transparent;
      color: #333;
      cursor: pointer;
      font-weight: 500;
      transition: all .2s;
    }
    .btn:hover {
      background: #e0e0e0;
    }
    .btn.active {
      background: linear-gradient(180deg, #fff, #e8e8e8);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
      color: #007aff;
      font-weight: 600;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat {
      flex: 1;
      min-width: 140px;
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .num {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111;
    }
    .lbl {
      font-size: 0.8rem;
      color: #777;
    }
    canvas {
      width: 100% !important;
      height: 380px !important;
    }
    footer {
      text-align: right;
      font-size: 0.8rem;
      color: #777;
      margin-top: 8px;
    }
    .side {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }
    select, input[type="number"] {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.9rem;
    }
    /* Modal styling */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(3px);
      z-index: 100;
    }
    .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      max-width: 340px;
      text-align: center;
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-content h2 {
      margin-top: 0;
      color: #007aff;
    }
    .modal-content p {
      color: #333;
      font-size: 0.95rem;
    }
    .close-btn {
      margin-top: 16px;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: #007aff;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
    }
    .close-btn:hover {
      background: #005ed1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š Live Dashboard Harga Emas (API Ninjas)</h1>
      <div class="btn-group">
        <button class="btn active" data-range="live">Live</button>
        <button class="btn" data-range="1d">1D</button>
        <button class="btn" data-range="1w">1W</button>
        <button class="btn" data-range="1m">1M</button>
        <button class="btn" data-range="1y">1Y</button>
        <button class="btn" data-range="5y">5Y</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="num" id="lastPrice">--</div>
        <div class="lbl">Harga Emas (USD)</div>
      </div>
      <div class="stat">
        <div class="num" id="converted">--</div>
        <div class="lbl">Setara (IDR)</div>
      </div>
      <div class="stat">
        <div class="num" id="asOf">--</div>
        <div class="lbl">Waktu Update</div>
      </div>
    </div>

    <canvas id="chart"></canvas>
    <footer>Data sumber: <b>API Ninjas - Commodity Price (Gold)</b></footer>

    <div class="side">
      <label>Interval</label>
      <select id="intervalSelect">
        <option value="60">60 Detik</option>
        <option value="1">1 Detik (Premium)</option>
      </select>
      <input type="number" id="alarmPrice" placeholder="Target IDR" style="width:130px;">
      <button id="setAlarmBtn" class="btn">Set Alarm</button>
      <button id="testAlarm" class="btn">ðŸ”Š Test Suara</button>
      <button id="refreshBtn" class="btn">Refresh</button>
    </div>
  </div>

  <!-- Modal Premium -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>ðŸ’Ž Mode Premium</h2>
      <p>Pembaruan per 1 detik hanya tersedia untuk pengguna berlangganan.</p>
      <p>Harga langganan: <b>Rp 700.000</b></p>
      <button class="close-btn" id="closeModal">Tutup</button>
    </div>
  </div>

  <!-- Modal Alarm -->
  <div class="modal" id="alarmModal">
    <div class="modal-content">
      <h2>ðŸš¨ Alarm Harga!</h2>
      <p>Harga emas telah menyentuh target yang kamu tetapkan ðŸŽ‰</p>
      <button class="close-btn" id="closeAlarm">Matikan Alarm</button>
    </div>
  </div>

<script>
const API_KEY = '1uJVdDfwabtrO+OjWyRHhA==hUYLyqpcRg8JyLHC';
const COMMODITY_URL = 'https://api.api-ninjas.com/v1/commodityprice?name=gold';
const RATE_URL = 'https://api.api-ninjas.com/v1/exchangerate?pair=USD_IDR';
const idrFmt = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });

let chart = null, timer = null, mode = 'live', currentInterval = 60;
let lastUSD = null, alarmTarget = null, alarmAudio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
const elUSD = document.getElementById('lastPrice');
const elIDR = document.getElementById('converted');
const elAsOf = document.getElementById('asOf');
const modal = document.getElementById('modal');
const alarmModal = document.getElementById('alarmModal');
const closeModal = document.getElementById('closeModal');
const closeAlarm = document.getElementById('closeAlarm');

document.getElementById('testAlarm').onclick = () => alarmAudio.play();

document.getElementById('setAlarmBtn').onclick = () => {
  const val = parseFloat(document.getElementById('alarmPrice').value);
  if (val && val > 0) {
    alarmTarget = val;
    alert("âœ… Alarm diset pada harga: " + idrFmt.format(val));
  } else {
    alert("Masukkan angka valid untuk alarm harga!");
  }
};

document.getElementById('intervalSelect').onchange = e => {
  const val = parseInt(e.target.value);
  if (val === 1) modal.style.display = 'flex';
  else { currentInterval = val; startLive(); }
};

closeModal.onclick = () => {
  modal.style.display = 'none';
  document.getElementById('intervalSelect').value = "60";
  currentInterval = 60;
  startLive();
};

closeAlarm.onclick = () => {
  alarmModal.style.display = 'none';
  alarmAudio.pause();
  alarmAudio.currentTime = 0;
};

document.getElementById('refreshBtn').onclick = () => loadData();
document.querySelectorAll('.btn-group .btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.btn-group .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    mode=btn.dataset.range; stopLive(); loadData();
  };
});

function startLive(){ stopLive(); timer=setInterval(fetchLatest, currentInterval*1000); }
function stopLive(){ if(timer) clearInterval(timer); }

async function fetchRate(){
  try {
    const r=await fetch(RATE_URL,{headers:{'X-Api-Key':API_KEY}});
    const j=await r.json(); return j.rate||16000;
  } catch { return 16000; }
}

async function fetchLatest(){
  try {
    const r=await fetch(COMMODITY_URL,{headers:{'X-Api-Key':API_KEY}});
    const j=await r.json();
    if(j && j.price){
      const usd=j.price, ts=new Date();
      lastUSD=usd; const rate=await fetchRate(); const idr=usd*rate;
      elUSD.textContent=usd.toFixed(2)+" USD";
      elIDR.textContent=idrFmt.format(idr);
      elAsOf.textContent=ts.toLocaleTimeString('id-ID');

      if(alarmTarget && idr>=alarmTarget){
        alarmModal.style.display='flex';
        alarmAudio.loop=true;
        alarmAudio.play();
        alarmTarget=null;
      }

      if(chart){
        chart.data.labels.push(ts.toLocaleTimeString('id-ID'));
        chart.data.datasets[0].data.push(idr);
        if(chart.data.labels.length>100){chart.data.labels.shift();chart.data.datasets[0].data.shift();}
        chart.update('none');
      }
    }
  }catch(e){console.warn(e);}
}

function synthesize(base,n){
  const arr=[],now=Date.now(); let p=base;
  for(let i=n-1;i>=0;i--){p*=(1+(Math.random()-0.5)*0.02);
    arr.push({t:new Date(now-i*3600*1000).toLocaleTimeString('id-ID'),v:p});
  } return arr;
}

async function loadData(){
  stopLive(); await fetchLatest();
  const base=lastUSD?(lastUSD*await fetchRate()):1000000;
  let pts=60;
  if(mode==='1d')pts=96; else if(mode==='1w')pts=140; else if(mode==='1m')pts=200;
  else if(mode==='1y')pts=300; else if(mode==='5y')pts=400;
  const s=synthesize(base,pts); const lbl=s.map(x=>x.t), dat=s.map(x=>x.v);
  createChart(lbl,dat); if(mode==='live')startLive();
}

function createChart(labels=[],data=[]){
  const ctx=document.getElementById('chart').getContext('2d');
  if(chart)chart.destroy();
  chart=new Chart(ctx,{type:'line',data:{
    labels,datasets:[{label:'Harga Emas (IDR)',data,borderColor:'#007aff',
    backgroundColor:'rgba(0,122,255,0.1)',borderWidth:2,tension:0.3,fill:true,pointRadius:0}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
    scales:{x:{ticks:{color:'#555'}},y:{ticks:{color:'#555',callback:v=>idrFmt.format(v)}}}}
  });
}

(async()=>{createChart([],[]);await loadData();})();
</script>
</body>
</html>
