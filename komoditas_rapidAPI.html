<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ“ˆ Live Dashboard Harga Emas (API Ninjas)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(160deg, #f3f4f6 0%, #e2e3e7 100%);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 960px;
      background: rgba(255,255,255,0.8);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.5);
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 10px;
    }
    h1 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: #222;
    }
    .btn-group {
      display: flex;
      gap: 6px;
      background: #f1f1f1;
      padding: 5px;
      border-radius: 12px;
    }
    .btn {
      border: none;
      padding: 7px 12px;
      border-radius: 8px;
      background: transparent;
      color: #333;
      cursor: pointer;
      font-weight: 500;
      transition: all .2s;
    }
    .btn:hover {
      background: #e0e0e0;
    }
    .btn.active {
      background: linear-gradient(180deg, #fff, #e8e8e8);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
      color: #007aff;
      font-weight: 600;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat {
      flex: 1;
      min-width: 140px;
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .num {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111;
    }
    .lbl {
      font-size: 0.8rem;
      color: #777;
    }
    canvas {
      width: 100% !important;
      height: 380px !important;
    }
    footer {
      text-align: right;
      font-size: 0.8rem;
      color: #777;
      margin-top: 8px;
    }
    .side {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }
    input {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 4px 8px;
      width: 60px;
      text-align: center;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š Live Dashboard Harga Emas (API Ninjas)</h1>
      <div class="btn-group">
        <button class="btn active" data-range="live">Live</button>
        <button class="btn" data-range="1d">1D</button>
        <button class="btn" data-range="1w">1W</button>
        <button class="btn" data-range="1m">1M</button>
        <button class="btn" data-range="1y">1Y</button>
        <button class="btn" data-range="5y">5Y</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat">
        <div class="num" id="lastPrice">--</div>
        <div class="lbl">Harga Emas (USD)</div>
      </div>
      <div class="stat">
        <div class="num" id="converted">--</div>
        <div class="lbl">Setara (IDR)</div>
      </div>
      <div class="stat">
        <div class="num" id="asOf">--</div>
        <div class="lbl">Waktu Update</div>
      </div>
    </div>

    <canvas id="chart"></canvas>
    <footer>Data sumber: <b>API Ninjas - Commodity Price (Gold)</b></footer>

    <div class="side">
      <label style="font-size:0.85rem;color:#555;">Live interval (detik)</label>
      <input id="liveInterval" type="number" value="10" min="3">
      <button id="refreshBtn" class="btn">Refresh Sekarang</button>
    </div>
  </div>

<script>
const API_KEY = '1uJVdDfwabtrO+OjWyRHhA==hUYLyqpcRg8JyLHC';
const COMMODITY_URL = 'https://api.api-ninjas.com/v1/commodityprice?name=gold';
const RATE_URL = 'https://api.api-ninjas.com/v1/exchangerate?pair=USD_IDR';

let chart = null;
let timer = null;
let mode = 'live';
let lastUSD = null;

const elUSD = document.getElementById('lastPrice');
const elIDR = document.getElementById('converted');
const elAsOf = document.getElementById('asOf');
const intervalInput = document.getElementById('liveInterval');
const idrFmt = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });

document.querySelectorAll('.btn-group .btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    mode = btn.dataset.range;
    stopLive();
    loadData();
  });
});

document.getElementById('refreshBtn').addEventListener('click', () => loadData());

function startLive(){
  stopLive();
  const sec = Math.max(3, parseInt(intervalInput.value) || 10);
  timer = setInterval(fetchLatest, sec * 1000);
}
function stopLive(){
  if(timer) clearInterval(timer);
}

async function fetchRateUSDToIDR(){
  try {
    const res = await fetch(RATE_URL, { headers: { 'X-Api-Key': API_KEY } });
    const j = await res.json();
    return j.rate || 16000;
  } catch {
    return 16000;
  }
}

async function fetchLatest(){
  try {
    const res = await fetch(COMMODITY_URL, { headers: { 'X-Api-Key': API_KEY } });
    const j = await res.json();
    if (j && j.price) {
      const usd = j.price;
      const ts = j.updated ? new Date(j.updated * 1000) : new Date();
      lastUSD = usd;

      const rate = await fetchRateUSDToIDR();
      const idr = usd * rate;

      elUSD.textContent = usd.toFixed(2) + " USD";
      elIDR.textContent = idrFmt.format(idr);
      elAsOf.textContent = ts.toLocaleString('id-ID');

      if (chart) {
        chart.data.labels.push(ts.toLocaleTimeString('id-ID'));
        chart.data.datasets[0].data.push(idr);
        if (chart.data.labels.length > 100) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        chart.update('none');
      }
    }
  } catch (e) {
    console.warn('fetchLatest error:', e);
  }
}

function synthesize(base, points) {
  const arr = [];
  const now = Date.now();
  let p = base;
  for (let i = points - 1; i >= 0; i--) {
    const delta = (Math.random() - 0.5) * 0.02;
    p *= (1 + delta);
    const t = new Date(now - i * 3600 * 1000);
    arr.push({ t: t.toLocaleTimeString('id-ID'), v: p });
  }
  return arr;
}

async function loadData(){
  stopLive();
  await fetchLatest();
  const base = lastUSD ? lastUSD * await fetchRateUSDToIDR() : 1000000;
  let pts = 60;
  if (mode === '1d') pts = 96;
  else if (mode === '1w') pts = 140;
  else if (mode === '1m') pts = 200;
  else if (mode === '1y') pts = 300;
  else if (mode === '5y') pts = 400;

  const series = synthesize(base, pts);
  const labels = series.map(s => s.t);
  const data = series.map(s => s.v);
  createChart(labels, data);
  if (mode === 'live') startLive();
}

function createChart(labels = [], data = []) {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Harga Emas (IDR)',
        data,
        borderColor: '#007aff',
        backgroundColor: 'rgba(0,122,255,0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#555' } },
        y: { ticks: { color: '#555', callback: v => idrFmt.format(v) } }
      }
    }
  });
}

(async () => {
  createChart([], []);
  await loadData();
})();
</script>
</body>
</html>
